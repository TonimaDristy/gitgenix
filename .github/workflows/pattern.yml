name: Generate GitHub Art

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Setup Git
        run: |
          git config user.name "TonimaDristy"
          git config user.email "tidristy477@gmail.com"

      - name: Read pattern.json and make commits
        run: |
          python3 - << 'EOF'
          import json, subprocess, os, sys
          from datetime import datetime

          if not os.path.exists('pattern.json'):
              sys.exit("ERROR: pattern.json not found in repo root")

          with open('pattern.json') as f:
              data = json.load(f)

          for entry in data:
              # Extract date and intensity
              date_str = entry.get("date")
              intensity = entry.get("intensity", 0)
              if not date_str or intensity == 0:
                  continue

              # Convert ISO date to YYYY-MM-DD
              date = datetime.fromisoformat(date_str.replace("Z","")).strftime("%Y-%m-%d")

              for i in range(intensity):
                  subprocess.run(["bash", "-c", f"echo '{date}' >> log.txt"])
                  subprocess.run(["git", "add", "."])
                  subprocess.run(["git", "commit", "--date", f"{date} 12:00:00", "-m", f"Commit on {date}"])
          EOF

      - name: Push changes
        run: git push
