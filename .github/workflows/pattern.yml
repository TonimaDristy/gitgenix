name: Generate GitHub Art

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Setup Git
        run: |
          git config user.name "TonimaDristy"
          git config user.email "tidristy477@gmail.com"

      - name: Read pattern.json and make commits
        run: |
          python3 - << 'EOF'
          import json, subprocess, os, sys

          if not os.path.exists('pattern.json'):
              sys.exit("ERROR: pattern.json not found in repo root")

          try:
              with open('pattern.json') as f:
                  data = json.load(f)
          except Exception as e:
              sys.exit(f"ERROR: Failed to parse JSON: {e}")

          for entry in data:
              date = entry.get("date")
              count = entry.get("count", 0)
              if not date:
                  continue
              for i in range(count):
                  subprocess.run(["bash", "-c", f"echo '{date}' >> log.txt"])
                  subprocess.run(["git", "add", "."])
                  subprocess.run(["git", "commit", "--date", f"{date} 12:00:00", "-m", f"Commit on {date}"])
          EOF

      - name: Push changes
        run: git push
