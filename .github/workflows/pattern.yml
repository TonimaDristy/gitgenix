name: Generate GitHub Art

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run GitGenix script
        run: |
          python - <<'EOF'
          import json
          import re
          from pathlib import Path

          def fix_json(raw_text):
              """Automatically fix common JSON issues and parse stringified objects"""
              # Remove trailing commas
              cleaned = re.sub(r',(\s*[\]}])', r'\1', raw_text)
              # Remove invisible characters and flatten
              cleaned = cleaned.replace('\n', '').replace('\t', '')
              try:
                  data = json.loads(cleaned)
              except json.JSONDecodeError as e:
                  print(f"Still invalid JSON: {e}")
                  raise

              # Recursively convert any stringified JSON objects
              def parse_strings(obj):
                  if isinstance(obj, dict):
                      return {k: parse_strings(v) for k, v in obj.items()}
                  elif isinstance(obj, list):
                      return [parse_strings(v) for v in obj]
                  elif isinstance(obj, str):
                      obj_strip = obj.strip()
                      if obj_strip.startswith('{') or obj_strip.startswith('['):
                          try:
                              return parse_strings(json.loads(obj_strip))
                          except:
                              return obj
                      else:
                          return obj
                  else:
                      return obj

              return parse_strings(data)

          # Load pattern.json
          path = Path("pattern.json")
          raw = path.read_text(encoding="utf-8")
          data = fix_json(raw)

          # Example: just print some info (replace with GitGenix logic)
          metadata = data.get("metadata", {})
          username = metadata.get("username", "unknown")
          repository = metadata.get("repository", "unknown")
          branch = metadata.get("branch", "main")
          print(f"Running GitGenix for {username}/{repository} on branch {branch}")

          # Here you can call your GitGenix contribution generation logic
          EOF
